# Data Models

## Overview

The system uses three distinct data storage strategies:

1. **Airtable (Source of Truth)** - Content management and client configuration
2. **Static JSON (Build-Time)** - Pre-exported content for Next.js builds
3. **Make.com + Salesforce (Runtime)** - Lead capture and CRM integration

**Data Flow:** Airtable → JSON Export → Next.js Build → Static HTML → User Interaction → Make.com → Salesforce

---

## 1. Airtable Data Model

> **⚠️ IMPORTANT - BACKEND SCHEMA STATUS:**
>
> **✅ AIRTABLE BACKEND IS COMPLETE AND PRODUCTION-READY**
>
> The Airtable base structure with all 12 tables, relationships, rollup fields, and automations has been **fully built and tested**.
>
> **🔒 Schema is LOCKED:**
> - Dev should **NOT modify the schema** (add/remove/change tables or fields) without explicit approval from Owner and Architect
> - Dev should **ONLY use the Airtable API** to create, read, and update records within the existing structure
> - Any schema changes require coordination with the Owner and Architect to ensure system integrity
>
> **📖 Full Schema Reference:** See `Archive/airtable-schema-phase1.md` for complete field definitions, relationships, automations, and examples.

**Base Name:** `Landing Pages Content Management`

**Base ID:** `appATvatPtaoJ8MmS`

**Purpose:** Central content repository managed by non-technical stakeholders

**Schema Status:** Phase 1 MVP - Production Ready (12 tables, 3,000 page capacity)

**Tables:** 12 core tables organized into 3 categories

### Table Structure Overview

**FOUNDATION TABLES** (6 tables)
1. **Clients** - Business information, branding, tracking IDs, contact info
2. **Services** - Service definitions with keyword grouping for SEO
3. **Locations** - Validated city master data with demographics
4. **Branch Locations** - Physical office locations with timezone support
5. **Service Areas** - Junction table (which branches serve which cities)
6. **Branch Staff** - Team member profiles for AI personalization

**CORE CONTENT TABLE** (1 table)
7. **Pages** - Landing page content and workflow management (50+ fields including auto-matched branch data, AI-generated content, SEO metadata)

**CONTENT LIBRARIES** (3 tables)
8. **CTAs** - Call-to-action library for AI selection
9. **Hero Images Library** - Image asset management with categorization
10. **Testimonials** - Customer reviews with service/branch targeting

**MARKETING TABLES** (2 tables)
11. **Offers** - Promotional campaigns with targeting rules
12. **Campaigns** - Marketing campaign tracking and UTM management

**Key Features:**
- ✅ Auto-number primary keys on all tables
- ✅ Linked records for relationships (Foreign Keys)
- ✅ 14 rollup fields for aggregated counts and metadata
- ✅ Formula fields for URL generation, slugs, and computed values
- ✅ 3 automations ready: Auto-Match Branch, Trigger AI Generation, Export on Approval
- ✅ Multiple views per table for different workflows

**For detailed field specifications, relationships, example records, and automation logic, see:**
📄 `Archive/airtable-schema-phase1.md` (Complete 1,700+ line schema specification)

### Detailed Table Specifications

The complete field-by-field specifications for all 12 tables are documented in the archived schema file. This includes:

- Complete field lists with types, required/optional flags, and examples
- Formula field definitions (URL slugs, unique keys, computed values)
- Lookup and rollup field configurations
- Relationship mappings between tables
- View configurations for each table
- Example records for reference
- Automation logic specifications

**See:** `Archive/airtable-schema-phase1.md` for full details on:
- Foundation Tables (Clients, Services, Locations, Branch Locations, Service Areas, Branch Staff)
- Core Content Table (Pages with 50+ fields)
- Content Libraries (CTAs, Hero Images Library, Testimonials)
- Marketing Tables (Offers, Campaigns)

---

## 2. Static JSON Data Model

**Generated by:** `scripts/export-airtable-to-json.js`

**Location:** `/content.json` (project root, gitignored)

**Purpose:** Pre-exported content consumed by Next.js at build time (no runtime API calls)

### Schema: `content.json`

```json
{
  "clients": [
    {
      "clientId": 42,
      "clientName": "Baths R Us",
      "domain": "https://bathsrus.com",
      "branding": {
        "primaryColor": "#0ea5e9",
        "secondaryColor": "#8b5cf6",
        "logoUrl": "https://res.cloudinary.com/client-logo.png",
        "googleFonts": "Inter"
      },
      "contact": {
        "phone": "(704) 555-1234",
        "email": "info@bathsrus.com"
      },
      "tracking": {
        "gtmId": "GTM-XXXXXXX",
        "callrailSwapTarget": "CR-123456",
        "recaptchaSiteKey": "6Lc...",
        "salesforceCampaignId": "7012A000000ABCD"
      },
      "webhooks": {
        "makeWebhookUrl": "https://hook.us1.make.com/abc123"
      }
    }
  ],
  "pages": [
    {
      "pageId": 1234,
      "service": "bathroom-remodeling",
      "location": "charlotte",
      "clientName": "Baths R Us",
      "seo": {
        "title": "Bathroom Remodeling Charlotte NC | Baths R Us",
        "description": "Top-rated bathroom remodeling in Charlotte...",
        "canonical": "https://bathsrus.com/bathroom-remodeling/charlotte"
      },
      "hero": {
        "h1": "Transform Your Bathroom in Charlotte",
        "subheadline": "Licensed, insured, and trusted by 500+ homeowners",
        "ctaText": "Get Free Quote",
        "ctaUrl": null,
        "imageUrl": "https://res.cloudinary.com/hero-image.jpg"
      },
      "contentBlocks": [
        {
          "blockId": 789,
          "blockType": "Feature",
          "heading": "Licensed & Insured",
          "bodyText": "Fully licensed contractors with $2M insurance",
          "iconName": "shield-check",
          "imageUrl": null,
          "order": 1,
          "aiGenerated": true
        }
      ],
      "metadata": {
        "createdDate": "2025-01-08T10:00:00Z",
        "lastModified": "2025-01-09T14:30:00Z"
      }
    }
  ],
  "exportMetadata": {
    "exportDate": "2025-01-09T15:00:00Z",
    "totalPages": 500,
    "totalClients": 25,
    "exportDurationMs": 12340
  }
}
```

**Size Estimate:** ~500KB for 500 pages (1KB per page average)

---

## 3. Form Submission Data Model

**Transmitted via:** AJAX POST to Make.com webhook

**Destination:** Make.com → Salesforce Lead object

**Protocol:** JSON over HTTPS

### Schema: Form Payload (Client → Make.com)

```json
{
  "leadData": {
    "fullName": "Victoria Smith",
    "phoneNumber": "46654767492",
    "email": "victoria@gmail.com",
    "zipCode": "28202",
    "jobType": "Full bathroom remodel",
    "howDidYouHear": "Online Search",
    "commentsOrQuestions": "Interested in walk-in shower conversion"
  },
  "utm": {
    "source": "google",
    "medium": "cpc",
    "campaign": "remodel-charlotte",
    "term": "bathroom remodeling charlotte",
    "content": "ad-variant-a"
  },
  "clickIds": {
    "gclid": "EAIaIQobChMI...",
    "gclidTimestamp": 1704729600000,
    "fbclid": null
  },
  "session": {
    "clientId": "GA1.1.123456789.1704729600",
    "sessionId": "1704729600",
    "landingPageUrl": "https://bathsrus.com/bathroom-remodeling/charlotte",
    "pageUrl": "https://bathsrus.com/bathroom-remodeling/charlotte",
    "referrer": "https://www.google.com/"
  },
  "timing": {
    "formStartTime": 1704729650000,
    "formSubmitTime": 1704729720000,
    "timeOnPage": 120,
    "formDuration": 70
  },
  "device": {
    "deviceType": "mobile",
    "browser": "Chrome",
    "viewportWidth": 375,
    "userAgent": "Mozilla/5.0 (iPhone; CPU iPhone OS 17_0...)"
  },
  "antiSpam": {
    "recaptchaToken": "03AGdBq27X..."
  },
  "metadata": {
    "timestamp": "2025-01-08T15:30:00Z",
    "formVersion": "3-stage-v1",
    "__amp_source_origin": "https://bathsrus.com"
  }
}
```

**See Also:** `docs/integrations/salesforce-integration-strategy.md` for complete field mapping and Make.com workflow documentation.

---

## 4. Salesforce Data Model

**Object:** `Lead` (standard Salesforce object)

**Mapped Fields (30+ custom fields):**

| Salesforce Field | Form Source | Type | Notes |
|------------------|-------------|------|-------|
| `FirstName` | `leadData.fullName` (parsed) | Text | Split from full name |
| `LastName` | `leadData.fullName` (parsed) | Text | Split from full name |
| `Phone` | `leadData.phoneNumber` | Phone | Formatted in Make.com |
| `Email` | `leadData.email` | Email | Optional (email stage) |
| `PostalCode` | `leadData.zipCode` | Text | 5-digit US zip |
| `LeadSource` | `utm.source` | Picklist | `google \| facebook \| bing` |
| `Description` | `leadData.commentsOrQuestions` | Long Text | User notes |
| `Campaign__c` | `utm.campaign` | Custom Text | Campaign name |
| `Ad_Group__c` | `utm.content` | Custom Text | Ad variant |
| `Keyword__c` | `utm.term` | Custom Text | Search term |
| `GCLID__c` | `clickIds.gclid` | Custom Text | Google Click ID |
| `Landing_Page__c` | `session.landingPageUrl` | Custom URL | First page in session |
| `Form_Duration__c` | `timing.formDuration` | Custom Number | Seconds to complete form |
| `Time_On_Page__c` | `timing.timeOnPage` | Custom Number | Engagement metric |
| `Device_Type__c` | `device.deviceType` | Custom Picklist | `mobile \| tablet \| desktop` |
| `Lead_Quality_Score__c` | (Calculated in Make.com) | Custom Number | 0-100 score |
| `reCAPTCHA_Score__c` | (Verified in Make.com) | Custom Number | 0.0-1.0 spam score |

**Assignment Rules:** Triggered by Make.com after Lead creation (based on `PostalCode`, `LeadSource`, `Lead_Quality_Score__c`)

---

## 5. Future Enhancements

> **Phase 1 MVP is LOCKED.** The current 12-table schema is production-ready and should not be modified without explicit approval from Owner and Architect.

**Phase 2 Proposal:** For a comprehensive enhancement proposal including:
- A/B testing via Page Variants table
- Flexible content blocks (modular page sections)
- Historical analytics tracking (Page Analytics table)
- Bulk import capabilities (500+ pages at once)
- Enhanced version control and approval workflows
- Advanced SEO and URL management

**See:** [`airtable-data-model-v2-FUTURE.md`](airtable-data-model-v2-FUTURE.md)

**Status:** Evaluated specification by architect, ready for future implementation (Phase 1.0+)

**Migration Path:** Document includes non-breaking migration strategy from Phase 1 (12 tables) → Phase 2 (15 tables)

---

## Data Validation Rules

### Airtable Validation (Manual Enforcement)

- **Service slug:** Lowercase, hyphens only, matches URL structure
- **Location slug:** Lowercase, hyphens only, matches URL structure
- **SEO Title:** 50-60 characters (Google SERP limit)
- **SEO Description:** 150-160 characters (Google SERP limit)
- **Phone Number:** Valid US format `(XXX) XXX-XXXX`
- **Email:** Valid email format
- **URL Fields:** Must start with `https://`
- **Hex Colors:** Must start with `#` and be 6-character hex

### Client-Side Form Validation (React Hook Form + Zod)

```typescript
// src/lib/form-schema.ts
import { z } from 'zod'

export const formSchema = z.object({
  fullName: z.string()
    .min(2, 'Name must be at least 2 characters')
    .regex(/^[a-zA-Z\s]+$/, 'Name can only contain letters'),

  phoneNumber: z.string()
    .regex(/^\d{10,11}$/, 'Phone must be 10-11 digits'),

  email: z.string()
    .email('Invalid email format')
    .optional()
    .or(z.literal('')),

  zipCode: z.string()
    .regex(/^\d{5}$/, 'ZIP code must be 5 digits'),

  jobType: z.string()
    .min(1, 'Please select a service'),

  howDidYouHear: z.string()
    .min(1, 'Please select an option'),

  commentsOrQuestions: z.string()
    .max(500, 'Comments must be under 500 characters')
    .optional()
})
```

### Server-Side Validation (Make.com Scenario)

- **reCAPTCHA Verification:** Score must be ≥ 0.5 (reject if < 0.5)
- **Lead Quality Score:** Calculate based on timing, device, engagement (0-100)
- **Duplicate Detection:** Check Salesforce for existing Lead with same email/phone (within 30 days)
- **Rate Limiting:** Max 10 submissions per IP per hour (anti-spam)

---

## Data Flow Summary

```
┌─────────────────────────────────────────────────────────┐
│  1. AIRTABLE (Source of Truth)                          │
│     - Content managed by stakeholders                   │
│     - Client branding configuration                     │
│     - AI content generation queue                       │
└─────────────────────────────────────────────────────────┘
                        ↓
              [Export Script: Nightly/On-Demand]
                        ↓
┌─────────────────────────────────────────────────────────┐
│  2. STATIC JSON (Build-Time Data)                       │
│     - content.json (500KB for 500 pages)                │
│     - No runtime API calls to Airtable                  │
│     - Consumed by Next.js getStaticPaths/Props          │
└─────────────────────────────────────────────────────────┘
                        ↓
              [Next.js Static Build]
                        ↓
┌─────────────────────────────────────────────────────────┐
│  3. STATIC HTML (Netlify CDN)                           │
│     - 500 pre-rendered pages                            │
│     - Zero runtime dependencies                         │
│     - Form client-side JS hydration                     │
└─────────────────────────────────────────────────────────┘
                        ↓
              [User Form Submission]
                        ↓
┌─────────────────────────────────────────────────────────┐
│  4. MAKE.COM WEBHOOK (Integration Layer)                │
│     - reCAPTCHA verification                            │
│     - Lead quality scoring                              │
│     - Field mapping to Salesforce                       │
└─────────────────────────────────────────────────────────┘
                        ↓
              [Salesforce API via OAuth 2]
                        ↓
┌─────────────────────────────────────────────────────────┐
│  5. SALESFORCE (CRM)                                    │
│     - Lead object with 30+ custom fields               │
│     - Assignment rules (territory-based)                │
│     - Automated notifications to sales reps             │
└─────────────────────────────────────────────────────────┘
```

---
